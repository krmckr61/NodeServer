'use strict';

var isIP = require('validator').isIP;
var Address = require('./lib/address');
var IP = require('./lib/ip');
var request = require('request');
var Result = require('./lib/result');

/*
 * callback: fn(err, result);
 */
var is = function(ipOrAddress, callback) {
  var locator;
  var opts;

    if (!ipOrAddress) {
        return callback(null, new Result());
    } else {
        if(!isIP(ipOrAddress)) {
            if(ipOrAddress.includes(',')) {
                let ipArr = ipOrAddress.split(',');
                ipOrAddress = ipArr[0].trim();
                if(!isIP(ipOrAddress)) {
                    console.log(ipOrAddress + ' -|-|-')
                    ipOrAddress = '169.99.135.47';
                }
            } else {
                console.log(ipOrAddress + ' ----- ');
                ipOrAddress = '167.99.135.47';
            }
        }
    }

    locator = new IP(ipOrAddress);


  opts = {
    method: 'GET',
    url: locator.url,
    json: true
  };

  request(opts, function(err, res, body) {
    if (err) {
      return callback(err);
    }

    callback(null, locator.buildResult(body));
  });
};

module.exports = {
  is: is
};
